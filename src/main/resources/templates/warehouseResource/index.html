<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>仓库资源管理</title>
    <script th:src="@{/js/jquery-3.2.1.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/ajax.js}"></script>
    <script language="javascript" type="text/javascript" th:src="@{/js/My97DatePicker/WdatePicker.js}"></script>
    <script type="text/javascript" th:src="@{/js/layui/layui.all.js}"></script>
    <link th:href="@{/js/layui/css/layui.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/css/base.css}" rel="stylesheet" type="text/css"/>
    <style>
        .steel_list_table input[type="text"] {
            border: 1px solid #dedede;
            text-align: center;
            padding: 1px 2px;
            width: 50px;
            height: 22px;
        }
    </style>
</head>
<body>
<div th:insert="~{header :: header}"></div>

<section>
    <div class="main w1000">
        <div th:insert="~{left :: left('warehouselist')}"></div>
        <aside>
            <div class="resources">
                <div class="resources_tt" th:include="common::varietyTag2"></div>


                <div class="pozition">
                    <p>当前位置：会员中心 &gt; 资源管理 &gt; 仓库资源管理</p>
                </div>

                <section>
                    <div class="steel_list w830">
                        <div class="ss">
                            <form name="form1" id="form1" th:action="@{'/warehouse_resource/index'}" method="post">
                                <table cellspacing="0" cellpadding="0" border="0">
                                    <tbody>
                                    <tr>
                                        <td><p>品名：</p><input type="text" name="varietyName" id="varietyName"
                                                             th:value="${warehouseResource.varietyName}" size="18"></td>
                                        <td><p>材质：</p><input type="text" name="material" id="material"
                                                             th:value="${warehouseResource.material}" size="18"></td>
                                        <td><p>规格：</p><input type="text" name="specification" id="specification"
                                                             th:value="${warehouseResource.specification}" size="18">
                                            <p></td>
                                    </tr>
                                    <tr>
                                        <td><p>产地：</p><input type="text" name="factory" id="factory"
                                                             th:value="${warehouseResource.factory}" size="18"></td>
                                        <td><p>仓库：</p><input type="text" name="warehouse" id="warehouse"
                                                             th:value="${warehouseResource.warehouse}" size="18"></td>
                                        <input type="hidden" name="page" id="page"/>
                                        <input type="hidden" th:name="${_csrf.parameterName}"
                                               th:value="${_csrf.token}"/>
                                        <td><a href="javascript:find();">搜索</a></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </form>
                        </div>
                        <form name="form2" id="form2" action="" method="post">
                            <table class="steel_list_table w830" cellspacing="0" cellpadding="0" border="0">
                                <thead>
                                <tr>
                                    <!--            <td class="checkbox">全选 <input type='checkbox' id="selallbox" onclick="selall();"/></td>-->
                                    <td>ID</td>
                                    <td>品名</td>
                                    <td>材质</td>
                                    <td>规格</td>
                                    <td>产地</td>
                                    <td>仓库</td>
                                    <td>可用数量</td>
                                    <td>预留数量</td>
                                    <td>预留时间</td>
                                    <td>审核时间</td>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="list:${warehouseResourceList}">
                                    <!--            <td class="checkbox"><input type='checkbox' name='checkednum' th:id="@{'checkednum_'+${list.id}}" th:value="${list.id}"/></td>-->
                                    <td th:text="${list.id}"></td>
                                    <td th:text="${list.varietyName}"></td>
                                    <td th:text="${list.material}"></td>
                                    <td th:text="${list.specification}" th:id="@{'specification_'+${list.id}}"></td>
                                    <td th:text="${list.factory}"></td>
                                    <td th:text="${list.warehouse}"></td>
                                    <td>
                                        <input type="text" th:name="@{'num_'+${list.id}}" th:id="@{'num_'+${list.id}}" th:value="${T(com.isechome.ecommerce.common.StringUtils).valueFormat(list.num)}" readonly/>
                                    </td>
                                    <td>
                                        <input type="text" th:name="@{'reserved_num_'+${list.id}}"
                                               th:id="@{'reserved_num_'+${list.id}}" th:value="${T(com.isechome.ecommerce.common.StringUtils).valueFormat(list.reservedNum)}"
                                               th:onblur="'update_resource(\''+${list.id}+'\',this.value,1), checkNum(this);'"/>
                                    </td>
                                    <td>
                                        <input type="text" th:name="@{'reserved_date_'+${list.id}}"
                                               th:id="@{'reserved_date_'+${list.id}}"
                                               style="width:95px;text-align:left;" class="Wdate"
                                               th:onclick="@{'WdatePicker({dateFmt:\'yyyy-MM-dd\', onpicked:function(){update_resource('+${list.id}+',this.value,2);}})'}"
                                               th:value="${#dates.format(list.reservedDate, 'yyyy-MM-dd')}"
                                               autocomplete="off"/>
                                    </td>

                                    <td th:text="${#dates.format(list.auditTime, 'yyyy-MM-dd HH:mm')}"></td>
                                </tr>
                                </tbody>
                            </table>

                            <div class="page">

                                <a th:href="'javascript:queryDeviceRecords('+${pageInfo.prePage}+');'">上一页</a>

                                <p th:each="navigatepageNum:${pageInfo.navigatepageNums}">
                                    <a th:if="${navigatepageNum} eq ${pageInfo.pageNum}" class="now"
                                       th:text="${navigatepageNum}"></a>
                                    <a th:if=" ${navigatepageNum} ne ${pageInfo.pageNum}"
                                       th:href="'javascript:queryDeviceRecords('+${navigatepageNum}+');'"
                                       th:text="${navigatepageNum}"></a>
                                </p>
                                <a th:href="'javascript:queryDeviceRecords('+${pageInfo.nextPage}+');'">下一页</a>


                                <span>到第</span>
                                <input type="text" id="jump_num">
                                <span>页</span>
                                <button type="button" onclick="jumppage();">确定</button>
                            </div>
                            <div class="batch">
                                <!-- <a class="bt" href="#">添加明细</a> -->
                                <a href="javascript:void(0)" class="bt" id="upload">入库资源导入</a>
                                <a href="/download/warehouse.xlsx">点击下载批量上传Excel模板</a>
                            </div>
                            <div class="order_confirm">
                                <div class="confirm">
                                    <input type="password" name="pwd" autocomplete="new-password"
                                           style="display: none;">
                                    <input type="password" name="pay_password" id="pay_password" placeholder="输入交易密码"
                                           style="margin: 0;">
                                    <!--
                                    <input th:if="${act} eq 'sh'" type="button" value="审核" onclick="updateStatus();">
                                    <input th:if="${act} eq 'sj'" type="button" value="上架" onclick="updateStatus();">
                                    <input th:if="${act} eq 'xj'" type="button" value="下架" onclick="updateStatus();">
                                    -->
                                    <input type="button" value="审核" onclick="audit();">
                                    <input type="hidden" name="allsel" id="allsel"/>
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                </div>
                            </div>
                        </form>
                        <div style="clear:both"></div>
                    </div>
                </section>
            </div>
        </aside>
    </div>
</section>

<div th:insert="~{footer :: footer}"></div>
<div th:include="common::commonFooter"></div>
</body>
<script>
    $(function () {
        //禁用“确认重新提交表单”
        window.history.replaceState(null, null, window.location.href);
    });
    // 翻页
    function jumppage() {
        var pageNum = document.getElementById("jump_num").value;
        if (pageNum > 0) {
            queryDeviceRecords(pageNum);
        }
    }

    function find(pageNum) {
        document.getElementById('form1').submit();
    }

    function queryDeviceRecords(pageNum) {
        $("#page").val(pageNum);
        document.getElementById('form1').submit();
    }

    function checkPrice(obj) {
        obj.value = obj.value.replace(/[^0-9]/g, '');
    }

    function checkNum(obj) {
        obj.value = obj.value.replace(/[^\d.]/g, ""); //清除“数字”和“.”以外的字符
        obj.value = obj.value.replace(/\.{2,}/g, "."); //只保留第一个. 清除多余的
        obj.value = obj.value.replace(".", "$#$").replace(/\./g, "").replace("$#$", ".");
        obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d\d).*$/, '$1$2.$3'); //只能输入三个小数
    }

    function audit() {
        var checkstr = checkPayWord();
        if (checkstr == "successed") {
            $.ajax({
                type: "POST",//方法类型
                dataType: "json",//预期服务器返回的数据类型
                url: "/warehouse_resource/audit_resource",//url
                data: {
                    'type': 1,
                    "[[${_csrf.parameterName}]]": "[[${_csrf.token}]]"
                },
                success: function (data) {
                    if (data.code == 0) {
                        alert("审核成功！");
                        location.reload();
                    } else {
                        alert("保存失败！");
                    }
                },
                error: function (request, status, error) {
                    console.log(error);
                    alert("保存失败！");
                }
            });
        }
    }

    function update_resource(id, value, type) {
        if (value == null || value == '') {
            layer.alert('请不要输入空值!', {closeBtn: 0}, function () {
                location.reload();
            });
        }
        var num = null;
        var date = null;
        if (type === 1) num = value;
        if (type === 2) date = value;
        if (num!=null || date !=null) {
            $.ajax({
                type: "post",
                url: "/warehouse_resource/update_resource",
                dataType: "json",
                data: {
                    'reservedNum': num,
                    'reservedDate': date,
                    'id': id,
                    'type': type,
                    "[[${_csrf.parameterName}]]": "[[${_csrf.token}]]"
                },
                success: function (data) {
                    if (data.code === 0 && type === 1) {
                        $("#num_" + id).val(data.data);
                    }

                    if (data.code !== 0) {
                        layer.alert(data.msg);
                        if (type === 1){
                            $("#reserved_num_" + id).val(0);
                        }
                    }
                    // setWeight(id, data);
                },
                error: function (request, status, error) {
                    console.log(error);
                }
            });
        }
        // document.getElementById("checkednum_" + id).checked = true;
    }

    function checkPayWord() {
        var inputPayWord = $("#pay_password").val();
        var str = "falsed";
        if (inputPayWord == "") {
            alert("请输入交易密码！");
            return str;
        }
        $.ajax({
            type: "post",
            url: "/resourcemanage/checkPayWord",
            dataType: "json",
            async: false,
            data: {
                'inputPayWord': inputPayWord,
                "[[${_csrf.parameterName}]]": "[[${_csrf.token}]]"
            },
            success: function (data) {
                if (data == "1") {
                    str = "successed";
                } else if (data == '2') {
                    alert("交易密码错误！")
                }
            },
            error: function (request, status, error) {
                console.log(error);
            }
        });
        return str;
    }

    layui.use(['upload', 'form', 'layer'], function () {
        var upload = layui.upload;
        var form = layui.form;
        var uploadInst = upload.render({
            elem: '#upload' //绑定元素
            , url: 'import'
            , data: {
                "[[${_csrf.parameterName}]]": "[[${_csrf.token}]]"
            }
            , accept: 'file'
            , acceptMime: 'application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            , exts: 'xls|xlsx'
            , size: 2048
            , before: function () {
                layer.load(1);
            }
            , done: function (res) {
                console.log(res);
                layer.closeAll('loading');
                if (res === 0) {
                    layer.alert('导入成功', {closeBtn: 0}, function () {
                        location.reload();
                    });

                } else if (res === -1) {
                    layer.alert('文件类型不正确或为空', {closeBtn: 0}, function () {
                        location.reload();
                    });
                } else {
                    layer.alert("有" + res + "条数据导入失败!", {closeBtn: 0}, function () {
                        location.reload();
                    });
                }
            }
            , error: function (message) {
                layer.closeAll('loading');
            }
        });
    });
</script>
</html>